<!DOCTYPE html>
<html>
<head>
<title>Hello WebSocket</title>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Expires" content="0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-control"
	content="no-cache, no-store, must-revalidate" />
<script src="sockjs-0.3.4.js"></script>
<script src="jquery_1.7.1.min.js"></script>
<script src="jquery.format-1.3.min.js"></script>
<script src="stomp.js"></script>
<style type="text/css">
.body {
	font: 16px courier, sans-serif;
}

.nowrap {
	white-space: nowrap;
}

.hidden {
	visibility: hidden;
}

.white-space-pre {
	white-space: pre-wrap;
}

.lightRed {
	background-color: red;
	color: white;
}

.lightYellow {
	background-color: yellow;
	color: black;
}

.lightGreen {
	background-color: green;
	color: white;
}

.lightInactive {
	background-color: gray;
	color: white;
}

.circle {
	position: relative;
	width: 120px;
	height: 120px;
	border: 1px solid black;
	text-align: center;
	border-radius: 150px;
	vertical-align: middle;
}

.lightTitle {
	padding-bottom: 10px;
}

.lightValue {
	font-size: 16px;
	font-weight: bold;
}

.lightValue {
	font-size: 16px;
	font-weight: bold;
}

.table {
	display: table;
	margin: 5px;
	padding: 5px;
}

.row {
	display: table-row;
}

.cell {
	display: table-cell;
/* 	width: 150px; */
/* 	height: 150px; */
	border: 1px solid black;
	padding:5px;
}

.cellSimple {
	display: table-cell;
}

.cellValue {
	font-size: 12px;
	font-weight: bold;
}


</style>

<script type="text/javascript">
	var stompClient = null;
	var dynCpuStatsWritten = 0;

	function setConnected(connected) {
		
		document.getElementById('connect').disabled = connected;
		document.getElementById('disconnect').disabled = !connected;
	}

	/**
	 * connect Stomp client and add subscriptions
	 */
	function connect() {
		var socket = new SockJS('/hello');
		stompClient = Stomp.over(socket);

		/* enable Stomp client debugging by uncommenting
		// append the debug log to a #debug div somewhere in the page using JQuery:
		stompClient.debug = function(str) {

			$("#debug").append(str + "\n");
		};
		 */

		stompClient.connect({}, function(frame) {

			setConnected(true);
			console.log('Connected: ' + frame);

			// subscribe CPU status broker
			stompClient.subscribe('/status/cpu', function(statusCpu) {

				var utilization = JSON.parse(statusCpu.body).utilization;
				updateLight(utilization);
			});
			
			// subscribe system status broker
			stompClient.subscribe('/status/system', function(statusSystem) {

				var cpuPercCombined = JSON.parse(statusSystem.body).cpuPercCombined;
				var memPercUsed = JSON.parse(statusSystem.body).memPercUsed;
				var uptime = JSON.parse(statusSystem.body).uptime;

				updateLight(cpuPercCombined, 'cpuPercCombined');
				updateLight(memPercUsed, 'memPercUsed');
				
				updateValue(uptime, 'uptime');
				
				var cpuStatsStatic = JSON.parse(statusSystem.body).staticCpuInfo;
				showStaticCpuStats(cpuStatsStatic);
				
				var cpuStatsDyn = JSON.parse(statusSystem.body).dynamicCpuInfos;
				showDynamicCpuStats(cpuStatsDyn);
				dynCpuStatsWritten = 1;
				
			});
		});
	}

	/**
	 * disconned Stomp client
	 */
	function disconnect() {
		if (stompClient != null) {
			stompClient.disconnect();
		}
		setConnected(false);
		console.log("Disconnected");
	}

	/**
	 * show static CPU stats
	 */
	function showStaticCpuStats(cpuStats) {
		
		if(cpuStats.cpuCacheSize > 0) {
			
			replaceValue(cpuStats.cpuCacheSize, 'cpuCacheSize');
		}
		
		replaceValue(cpuStats.cpuTotalCores, 'cpuTotalCores');
		replaceValue(cpuStats.cpuMhz, 'cpuMhz');
		replaceValue(cpuStats.cpuModel, 'cpuModel');
		replaceValue(cpuStats.cpuVendor, 'cpuVendor');
	}
	
	/**
	 * show dynamic CPU stats
	 */
	function showDynamicCpuStats(cpuStats) {
		
		if(cpuStats != null) {
			
			//
			// CPU util. percentages
			//
			
			for (var i = 0; i < cpuStats.length; i++){
				
				writeDynamicCpuLine(cpuStats[i], i, 'Perc');
			}

			var dynamicCpuRowNodeOrig = document.getElementById('dynamicCpuRowPerc');
			if(dynamicCpuRowNodeOrig != null) {
				
				dynamicCpuRowNodeOrig.outerHTML = "";
			}

			//
			// CPU util. times
			//
			
			for (var i = 0; i < cpuStats.length; i++){
				
				writeDynamicCpuLine(cpuStats[i], i, 'Times');
			}
			
			dynamicCpuRowNodeOrig = document.getElementById('dynamicCpuRowTimes');
			if(dynamicCpuRowNodeOrig != null) {
				
				dynamicCpuRowNodeOrig.outerHTML = "";
			}
		}

	}
	
	/**
	 * cpu: dyn. CPU json data object
     * index: CPU index 
	 * suffix: dynamicCpuRow id suffix, e.g. Perc
	 */
	function writeDynamicCpuLine(cpuStats, index, suffix) {
		
		var dynamicCpuRowNodeOrig = document.getElementById('dynamicCpuRow' + suffix);
		var dynamicCpuRowNode = dynamicCpuRowNodeOrig;

		if(dynamicCpuRowNode == null) {
			
			dynamicCpuRowNode = document.getElementById('dynamicCpuRow' + suffix + index);
		} else {
			
		}

		var dynamicCpuRowNodeClone = dynamicCpuRowNode.cloneNode(true);

		var dynamicCpuTableNode = document.getElementById('dynamicCpuTable' + suffix);
		
		var divTags = dynamicCpuRowNodeClone.getElementsByTagName('div');

		for(var i=0; i<divTags.length; i++) {
			
			var divElement = divTags[i];
			
			var id = divElement.id;
			
			if(id != null) {
				
				divElement.id = id + index;
				
			}
		}
		
		if(dynamicCpuRowNodeClone != null) {
			
			dynamicCpuRowNodeClone.id = 'dynamicCpuRow' + suffix + index;
			
			if(dynCpuStatsWritten == 0) {
				
			    dynamicCpuTableNode.appendChild(dynamicCpuRowNodeClone);
			    dynamicCpuRowNodeClone.classList.remove('hidden');
			}
		}

	    for (var key in cpuStats) {
	    	
	        var elementName = key;
	        var value = cpuStats[key];
	        
	        if(elementName.lastIndexOf('Perc') > -1) {
	        	
	        	value = $.format.number(value * 100, '##0.00');
	        }
	        else if(elementName.lastIndexOf('Time') > -1) {
	        	
	        	value = $.format.number(value / 60 / 60, '##0.00');
	        }
	        else if(elementName.lastIndexOf('cpuNumber') > -1) {
	        	
// 	        	$("#debug").append("suffix: " + suffix + ", value: " + value + "\n");

				// as we reuse the "cpuNumber" element in different tables, add a suffix
	        	elementName = elementName + suffix;
	        }
	        
	        replaceValue(value, elementName + index);
	        
	    }
		
	}
	
	/**
	 * replace a value (as text node) into a node
	 */
	function replaceValue(value, nodeName) {
		
		var node = document.getElementById(nodeName);

		if(node != null) {
			
			node.replaceChild(document.createTextNode(value), node.childNodes[0]);
		}
	}

	/**
	 * update some element with a value but format before depending on content
	 */
	function updateValue(value, elementName) {
		
		var elementStatusBox = document.getElementById(elementName);

		// uptime
		if (elementName == 'uptime') {
			
			if(value != null && value > 0) {
				
			} else {
				
				value = 'NO DATA';
			}
			
			if(typeof value == 'number') {
				
				value = $.format.number(value, '##0.00');
			}

		}

		if (value != null) {

			// debug only
			var elementDebug = document.getElementById('debug');
			var emptyTextNode = document.createTextNode('');
			elementDebug.replaceChild(emptyTextNode, elementDebug.childNodes[0]);
			elementDebug.classList.remove('hidden');

			// make visible
			elementStatusBox.classList.remove('hidden');
		}
		
		replaceValue(value, elementName);
	}

	/**
	 * update major system status lights into red/green/yellow
	 */
	function updateLight(value, elementNamePrefix) {


		// $("#debug").append("content: " + content + "\n");

		var elementLight = document.getElementById(elementNamePrefix + 'Light');
		var elementStatusBox = document.getElementById(elementNamePrefix);

		if (value != null) {

			// debug only
			var elementDebug = document.getElementById('debug');
			var emptyTextNode = document.createTextNode('');
			elementDebug.replaceChild(emptyTextNode, elementDebug.childNodes[0]);
			elementDebug.classList.remove('hidden');

			// make visible
			elementStatusBox.classList.remove('hidden');
		}

		elementStatusBox.classList.remove('lightRed');
		elementStatusBox.classList.remove('lightGreen');
		elementStatusBox.classList.remove('lightYellow');
		elementStatusBox.classList.remove('lightInactive');

		
		if (value > 66) {
			
			elementStatusBox.classList.add('lightRed');
		} else if (value <= 66 && value > 33) {
			
			elementStatusBox.classList.add('lightYellow');
		} else if (value <= 33 && value >= 0) {
			
			elementStatusBox.classList.add('lightGreen');
		} else {
			
			elementStatusBox.classList.add('lightInactive');
		}

		if(typeof value == 'number') {
			
			value = $.format.number(value, '##0.00');
		}

		var newValueTextNode = document.createTextNode(value);

		elementLight.replaceChild(newValueTextNode, elementLight.childNodes[0]);
	}

	function replaceAll(str, find, replace) {

		return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
	}

	function escapeRegExp(str) {
		return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
	}
</script>
</head>
<body onload="disconnect()" class="body">
	<noscript>
		<h2 style="color: #ff0000">Seems your browser doesn't support
			Javascript! Websocket relies on Javascript being enabled. Please
			enable Javascript and reload this page!</h2>
	</noscript>
	<div>
		<div id="debug" class="hidden">&#160;</div>
		<div>
			<button id="connect" onclick="connect();">Connect</button>
			<button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
		</div>
		<div class="table">
			<div class="row">
				<div id="cpuPercCombined" class="cell lightInactive circle">
					<div class="lightTitle">CPU<br/>Utilization</div>
					<div id="cpuPercCombinedLight" class="lightValue">NO DATA</div>
				</div>
				<div class="cellSimple" style="padding:5px;">
				</div>
				<div id="memPercUsed" class="cell lightInactive circle">
					<div class="lightTitle">Memory<br/>Utilization</div>
					<div id="memPercUsedLight" class="lightValue">NO DATA</div>
				</div>
			</div>
		</div>
		<div class="table">
			<div class="row">
				<div class="cellSimple">CPU Uptime: </div>
				<div id="uptime" class="cellValue" class="cell lightInactive">
					NO DATA
				</div>
			</div>
		</div>		
		<div class="table">
			<div class="row">CPU (Static)</div>
			<div id="staticCpu" class="row">
				<div class="cell lightInactive">
					<div class="lightTitle">Vendor</div>
					<div id="cpuVendor" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">Model</div>
					<div id="cpuModel" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">Frequency</div>
					<div id="cpuMhz" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">Total Cores</div>
					<div id="cpuTotalCores" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">Cache Size</div>
					<div id="cpuCacheSize" class="cellValue">NO DATA</div>
				</div>
			</div>
		</div>
		<div id="dynamicCpuTablePerc" class="table">
			<div class="row">CPU (Dynamic %)</div>
			<div class="row">
				<div class="cell lightInactive">
					<div class="lightTitle">CPU #</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">Idle</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">SYS</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">TOTAL/COMBINED</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">USER</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">WAIT</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">IRQ</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">NICE</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">SOFT IRQ</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">STOLEN</div>
				</div>
			</div>			
			<div id="dynamicCpuRowPerc" class="row hidden">
				<div class="cell lightInactive">
					<div id="cpuNumberPerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="idlePerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="sysPerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="combinedPerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="userPerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="waitPerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="irqPerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="nicePerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="softIrqPerc" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="stolenPerc" class="cellValue">NO DATA</div>
				</div>
			</div>
		</div>
			
		<div id="dynamicCpuTableTimes" class="table">
			<div class="row">CPU (Dynamic times)</div>
			<div class="row">
				<div class="cell lightInactive">
					<div class="lightTitle">CPU #</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">Idle</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">SYS</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">TOTAL/COMBINED</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">USER</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">WAIT</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">IRQ</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">NICE</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">SOFT IRQ</div>
				</div>
				<div class="cell lightInactive">
					<div class="lightTitle">STOLEN</div>
				</div>
			</div>
			<div id="dynamicCpuRowTimes" class="row hidden">
				<div class="cell lightInactive">
					<div id="cpuNumberTimes" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="idleTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="sysTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="totalTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="userTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="waitTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="irqTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="niceTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="softIrqTime" class="cellValue">NO DATA</div>
				</div>
				<div class="cell lightInactive">
					<div id="stolenTime" class="cellValue">NO DATA</div>
				</div>
			</div>
		</div>
	</div>
</body>

</html>
