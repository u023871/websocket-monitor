<!DOCTYPE html>
<html>
<head>
<title>WebSocket Monitor</title>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Expires" content="0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-control"
	content="no-cache, no-store, must-revalidate" />
<script src="js/websocket/sockjs-0.3.4.js"></script>
<script src="js/websocket/stomp.js"></script>
<script src="js/jquery/jquery.min-1.9.1.js"></script>
<script src="js/jquery/jquery.format-1.3.min.js"></script>
<script src="js/kickstart.js"></script>
<!-- KICKSTART -->
<link rel="stylesheet" href="css/kickstart.css" media="all" />
<!-- KICKSTART -->
<style type="text/css">
.body {
	font: 16px courier, sans-serif;
}

.nowrap {
	white-space: nowrap;
}

.hidden {
	visibility: hidden;
}

.white-space-pre {
	white-space: pre-wrap;
}

.lightRed {
	background-color: red;
	color: white;
}

.lightYellow {
	background-color: yellow;
	color: black;
}

.lightGreen {
	background-color: green;
	color: white;
}

.lightInactive {
	background-color: gray;
	color: white;
}

.circle {
	position: relative;
	width: 120px;
	height: 120px;
	border: 1px solid black;
	text-align: center;
	border-radius: 150px;
	vertical-align: middle;
}

.lightTitle {
	padding-bottom: 10px;
}

.lightValue {
	font-size: 16px;
	font-weight: bold;
}

.lightValue {
	font-size: 16px;
	font-weight: bold;
}

.table {
	display: table;
	margin: 5px;
	padding: 5px;
}

.row {
	display: table-row;
}

.cell {
	display: table-cell;
	/* 	width: 150px; */
	/* 	height: 150px; */
	border: 1px solid black;
	padding: 5px;
}

.cellSimple {
	display: table-cell;
}

.cellValue {
	font-size: 12px;
	font-weight: bold;
}
</style>

<script type="text/javascript">

	var stompClient = null;
	var dynCpuStatsWritten = false;
	var staticSystemStatsWritten = false;
	var currentHostId = 0;

	/**
	 * init on load
	 */
	function initialize() {
		
		disconnect();
		loadHosts();
	}
	
	/**
	 * load hosts on load
	 */
	function loadHosts() {
		
	    $.ajax({
	        url: "http://localhost:9090/hosts"
	    }).then(function(data) {
	    	
	    	currentHostId = data._embedded.hosts[0].id;
	    	
	       	$('#host-ip').text(data._embedded.hosts[0].ip);
	       	$('#host-name').text(data._embedded.hosts[0].name);
	       	$('#host-url').text(data._embedded.hosts[0].url);

		    
		    setCurrentHost(data._embedded.hosts[0]);
		});
	};
	
	
	/**
	 * load hosts on load
	 */
	function getHost(id) {
		
	    var host;

	    // TODO: how to...?
	    $.ajax({
	        type: "GET",
	        url: "http://localhost:9090/hosts/" + id,
	        async: false,
	        success : function(data) {
	            host = data;
	        }
	    });

	    return host;
	};
	
	/**
	 * load hosts on load
	 */
	function setCurrentHost(host) {
		
		if(host != null) {
			
		   	$('#currentHost').text(host.name);
		}
	};
	
	/**
	 * set status to dis/connected
	 */
	function setConnected(connected) {
		
		document.getElementById('connect').disabled = connected;
		document.getElementById('disconnect').disabled = !connected;
		
		if(connected) {
			
			document.getElementById('disconnect').classList.remove('disabled');
			document.getElementById('connect').classList.add('disabled');
		} else {
			document.getElementById('disconnect').classList.add('disabled');
			document.getElementById('connect').classList.remove('disabled');
		}
	}

	/**
	 * connect Stomp client and add subscriptions
	 */
	function connect() {
		
// 		var socket = new SockJS('/hello');
		var socket = new SockJS('http://192.168.1.43:9090/hello');
		stompClient = Stomp.over(socket);

		/* enable Stomp client debugging by uncommenting
		// append the debug log to a #debug div somewhere in the page using JQuery:
		stompClient.debug = function(str) {

			$("#debug").append(str + "\n");
		};
		 */

		stompClient.connect({}, function(frame) {

			setConnected(true);
			console.log('Connected: ' + frame);
			
			// subscribe static system status broker
			stompClient.subscribe('/status/system/static', function(staticSystemStatus) {

				var cpuStatsStatic = JSON.parse(staticSystemStatus.body).staticCpuInfo;
				showStaticCpuStats(cpuStatsStatic);
				
				var sysStatsStatic = JSON.parse(staticSystemStatus.body).staticSystemInfo;
				showStaticSystemStats(sysStatsStatic);
				
				var fsStatsStatic = JSON.parse(staticSystemStatus.body).staticFileSystemInfos;
				showStaticFileSystemStats(fsStatsStatic);
				
				staticSystemStatsWritten = true;
			});
			
			// subscribe dynamic system status broker
			stompClient.subscribe('/status/system/dynamic', function(dynamicSystemStatus) {

				var cpuPercCombined = JSON.parse(dynamicSystemStatus.body).cpuPercCombined;
				var memPercUsed = JSON.parse(dynamicSystemStatus.body).memPercUsed;
				var uptime = JSON.parse(dynamicSystemStatus.body).uptime;

				updateLight(cpuPercCombined, 'cpuPercCombined');
				updateLight(memPercUsed, 'memPercUsed');
				
				updateValue(uptime, 'uptime');
				
				var cpuStatsDyn = JSON.parse(dynamicSystemStatus.body).dynamicCpuInfos;
				showDynamicCpuStats(cpuStatsDyn);
				
				dynCpuStatsWritten = true;
			});
		});
	}

	/**
	 * disconned Stomp client
	 */
	function disconnect() {
		if (stompClient != null) {
			stompClient.disconnect();
		}
		setConnected(false);
		console.log("Disconnected");
	}

	/**
	 * show static CPU stats
	 */
	function showStaticCpuStats(cpuStats) {
		
		if(cpuStats.cpuCacheSize > 0) {
			
			replaceValue(cpuStats.cpuCacheSize, 'cpuCacheSize');
		}
		
		replaceValue(cpuStats.cpuTotalCores, 'cpuTotalCores');
		replaceValue(cpuStats.cpuMhz, 'cpuMhz');
		replaceValue(cpuStats.cpuModel, 'cpuModel');
		replaceValue(cpuStats.cpuVendor, 'cpuVendor');
	}
	
	/**
	 * show other static stuff
	 */
	function showStaticSystemStats(sysStats) {
		
		if(sysStats != null) {
			
			// FQDN
			replaceValue(sysStats.fqdn, 'fqdn');
		}
	}
	
	
	/**
	 * show static file system stuff
	 */
	function showStaticFileSystemStats(fsStats) {
		
		// static file system info
		if(fsStats != null) {
			
			for (var i = 0; i < fsStats.length; i++){
				
				writeTableRow(fsStats[i], i, "", "staticFileSystemRow", "staticFileSystemTable", staticSystemStatsWritten);
			}

			// ensure to remove template row
			var staticFileSystemRowNode = document.getElementById("staticFileSystemRow");
			if(staticFileSystemRowNode != null) {
				
				staticFileSystemRowNode.outerHTML = "";
			}
		}
	}
	
	/**
	 * show dynamic CPU stats
	 */
	function showDynamicCpuStats(cpuStats) {
		
		if(cpuStats != null) {
			
			//
			// CPU util. percentages
			//
			
			for (var i = 0; i < cpuStats.length; i++){
				
				writeTableRow(cpuStats[i], i, 'Perc', 'dynamicCpuRow', 'dynamicCpuTable', dynCpuStatsWritten);
			}

			// ensure to remove template row
			var dynamicCpuRowNodeOrig = document.getElementById('dynamicCpuRowPerc');
			if(dynamicCpuRowNodeOrig != null) {
				
				dynamicCpuRowNodeOrig.outerHTML = "";
			}

			//
			// CPU util. times
			//
			
			for (var i = 0; i < cpuStats.length; i++){
				
				writeTableRow(cpuStats[i], i, 'Times', 'dynamicCpuRow', 'dynamicCpuTable', dynCpuStatsWritten);
			}
			
			// ensure to remove template row
			dynamicCpuRowNodeOrig = document.getElementById('dynamicCpuRowTimes');
			if(dynamicCpuRowNodeOrig != null) {
				
				dynamicCpuRowNodeOrig.outerHTML = "";
			}
		}

	}
	
	/**
	 * cpu: dyn. CPU json data object
     * index: CPU index 
	 * suffix: dynamicCpuRow id suffix, e.g. Perc
	 */
	function writeTableRow(rowBean, index, suffix, rowElementName, tableElementName, rowTemplateCloneAlreadyAppendedAndUnhidden) {
		
		 
		var rowNodeOrig = document.getElementById(rowElementName + suffix);
		var rowNode = rowNodeOrig;

		var rowNodeClone = null;

		if(rowNode == null) {
			
			$jqClone = $('#' + rowElementName + suffix + index).clone();
			
		} else {
			
			$jqClone = $('#' + rowElementName + suffix).clone();

		}

		// this works only if there is exactly one match
		if($jqClone != null && $jqClone.length > 0) {
			
			rowNodeClone = $jqClone.get()[0];
		}
		
		var tableNode = document.getElementById(tableElementName + suffix);
		
		var divTags = rowNodeClone.getElementsByTagName('td');

		// iterate all div tags and append index to them
		for(var i=0; i<divTags.length; i++) {
			
			var divElement = divTags[i];
			
			var id = divElement.id;
			
			if(id != null && '' != id) {
				
				divElement.id = id + index;
			}
		}
		
		if(rowNodeClone != null) {
			
			// set new id to clone
			rowNodeClone.id = rowElementName + suffix + index;
		
			// unhide and append clone if row has not yet been rendered before
			if(!rowTemplateCloneAlreadyAppendedAndUnhidden) {
				
			    tableNode.appendChild(rowNodeClone);
			    rowNodeClone.classList.remove('hidden');
			}
		}

		// replace all elements' values matching bean property names
	    for (var key in rowBean) {
	    	
	        var elementName = key;
	        var value = rowBean[key];
	        
	        if(elementName.lastIndexOf('Perc') > -1) {
	        	
	        	value = $.format.number(value * 100, '##0.00') + '%';
	        }
	        else if(elementName.lastIndexOf('Time') > -1) {
	        	
	        	value = $.format.number(value / 1000, '##0.00') + 's';
	        }
	        else if(elementName.lastIndexOf('cpuNumber') > -1) {
	        	
				// as we reuse the "cpuNumber" element in different tables, add a suffix
	        	elementName = elementName + suffix;
	        }
	        
	        replaceValue(value, elementName + index);
	        
	    }
		
	}
	
	/**
	 * replace a value (as text node) into a node
	 */
	function replaceValue(value, nodeName) {
		
		var node = document.getElementById(nodeName);

		if(node != null) {
			
// 			node.innerHTML = value;
//  			delete node.value;
// 			node.value = value;
			node.replaceChild(document.createTextNode(value), node.childNodes[0]);
		}
	}

	/**
	 * update some element with a value but format before depending on content
	 */
	function updateValue(value, elementName) {
		
		var elementStatusBox = document.getElementById(elementName);

		// uptime
		if (elementName == 'uptime') {
			
			if(value != null && value > 0) {
				
			} else {
				
				value = 'NO DATA';
			}
			
			if(typeof value == 'number') {
				
				value = $.format.number(value, '##0.00');
			}

		}

		if (value != null) {

			// debug only
			var elementDebug = document.getElementById('debug');
			var emptyTextNode = document.createTextNode('');
			elementDebug.replaceChild(emptyTextNode, elementDebug.childNodes[0]);
			elementDebug.classList.remove('hidden');

			// make visible
			elementStatusBox.classList.remove('hidden');
		}
		
		replaceValue(value, elementName);
	}

	/**
	 * update major system status lights into red/green/yellow
	 */
	function updateLight(value, elementNamePrefix) {


		// $("#debug").append("content: " + content + "\n");

		var elementLight = document.getElementById(elementNamePrefix + 'Light');
		var elementStatusBox = document.getElementById(elementNamePrefix);

		if (value != null) {

			// debug only
			var elementDebug = document.getElementById('debug');
			var emptyTextNode = document.createTextNode('');
			elementDebug.replaceChild(emptyTextNode, elementDebug.childNodes[0]);
			elementDebug.classList.remove('hidden');

			// make visible
			elementStatusBox.classList.remove('hidden');
		}

		elementStatusBox.classList.remove('lightRed');
		elementStatusBox.classList.remove('lightGreen');
		elementStatusBox.classList.remove('lightYellow');
		elementStatusBox.classList.remove('lightInactive');

		
		if (value > 66) {
			
			elementStatusBox.classList.add('lightRed');
		} else if (value <= 66 && value > 33) {
			
			elementStatusBox.classList.add('lightYellow');
		} else if (value <= 33 && value >= 0) {
			
			elementStatusBox.classList.add('lightGreen');
		} else {
			
			elementStatusBox.classList.add('lightInactive');
		}

		if(typeof value == 'number') {
			
			value = $.format.number(value, '##0.00');
		}

		var newValueTextNode = document.createTextNode(value);

		elementLight.replaceChild(newValueTextNode, elementLight.childNodes[0]);
	}

	/**
	 * replace a string inside another string 
	 */
	function replaceAll(str, find, replace) {

		return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
	}

	/**
	 * escape regex patten in a string
	 */
	function escapeRegExp(str) {
		return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
	}
</script>
</head>
<body onload="initialize()" class="body">
	<noscript>
		<h2 style="color: #ff0000">Seems your browser doesn't support
			Javascript! Websocket relies on Javascript being enabled. Please
			enable Javascript and reload this page!</h2>
	</noscript>

	<div>
		<div id="debug" class="hidden">&#160;</div>

		<div>
			<button id="connect" class="pill" onclick="connect();">Connect</button>
			<button id="disconnect" class="pill" disabled="disabled"
				onclick="disconnect();">Disconnect</button>
		</div>

		<h3>Available hosts</h3>
		<table class="stripped">
			<thead>
				<tr>
					<th>IP</th>
					<th>Name</th>
					<th>URL</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td id="host-ip">NO DATA</td>
					<td id="host-name">NO DATA</td>
					<td id="host-url">NO DATA</td>
				</tr>
			</tbody>
		</table>

		<!-- colored CPU + memory usage lights -->
		<h1 id="currentHost">NO DATA</h1>
		<div class="table">
			<div class="row">
				<div id="cpuPercCombined" class="cell lightInactive circle">
					<div class="lightTitle">
						CPU<br />Utilization
					</div>
					<div id="cpuPercCombinedLight" class="lightValue">NO DATA</div>
				</div>
				<div class="cellSimple" style="padding: 5px;"></div>
				<div id="memPercUsed" class="cell lightInactive circle">
					<div class="lightTitle">
						Memory<br />Utilization
					</div>
					<div id="memPercUsedLight" class="lightValue">NO DATA</div>
				</div>
			</div>
		</div>

		<h3>Static metrics</h3>
		<table class="stripped">
			<thead>
				<tr>
					<th>Metric</th>
					<th>Value</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<th>Uptime</th>
					<td id="uptime">NO DATA</td>
				</tr>
				<tr>
					<th>FQDN</th>
					<td id="fqdn">NO DATA</td>
				</tr>
			</tbody>
		</table>

		<h3>CPU (Static)</h3>
		<table class="stripped sortable">
			<thead>
				<tr>
					<th>Vendor</th>
					<th>Model</th>
					<th>Frequency</th>
					<th>Total Cores</th>
					<th>Cache Size</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td id="cpuVendor" class="cellValue">NO DATA</td>
					<td id="cpuModel" class="cellValue">NO DATA</td>
					<td id="cpuMhz" class="cellValue">NO DATA</td>
					<td id="cpuTotalCores" class="cellValue">NO DATA</td>
					<td id="cpuCacheSize" class="cellValue">NO DATA</td>
				</tr>
			</tbody>
		</table>

		<h3>CPU (Dynamic %)</h3>
		<table id="dynamicCpuTablePerc" class="stripped sortable">
			<thead>
				<tr>
					<th>CPU #
					<th>Idle</th>
					<th>SYS</th>
					<th>TOTAL/COMBINED</th>
					<th>USER</th>
					<th>WAIT</th>
					<th>IRQ</th>
					<th>NICE</th>
					<th>SOFT IRQ</th>
					<th>STOLEN</th>
				</tr>
			</thead>
			<tbody>
				<tr id="dynamicCpuRowPerc" class="hidden">
					<td id="cpuNumberPerc" class="cellValue" />
					<td id="idlePerc" class="cellValue" />
					<td id="sysPerc" class="cellValue" />
					<td id="combinedPerc" class="cellValue" />
					<td id="userPerc" class="cellValue" />
					<td id="waitPerc" class="cellValue" />
					<td id="irqPerc" class="cellValue" />
					<td id="nicePerc" class="cellValue" />
					<td id="softIrqPerc" class="cellValue" />
					<td id="stolenPerc" class="cellValue" />
				</tr>
			</tbody>
		</table>
	
		<h3>CPU (Dynamic times)</h3>
		<table id="dynamicCpuTableTimes" class="stripped sortable">
			<thead>
				<tr>
					<th>CPU #</th>
					<th>Idle</th>
					<th>SYS</th>
					<th>TOTAL/COMBINED</th>
					<th>USER</th>
					<th>WAIT</th>
					<th>IRQ</th>
					<th>NICE</th>
					<th>SOFT IRQ</th>
					<th>STOLEN</th>
				</tr>
			</thead>
			<tbody>
				<tr id="dynamicCpuRowTimes" class="hidden">
					<td id="cpuNumberTimes" class="cellValue" />
					<td id="idleTime" class="cellValue" />
					<td id="sysTime" class="cellValue" />
					<td id="totalTime" class="cellValue" />
					<td id="userTime" class="cellValue" />
					<td id="waitTime" class="cellValue" />
					<td id="irqTime" class="cellValue" />
					<td id="niceTime" class="cellValue" />
					<td id="softIrqTime" class="cellValue" />
					<td id="stolenTime" class="cellValue" />
				</tr>
			</tbody>
		</table>
	
		<!-- TODO: colored FS usage lights -->
		<div class="table">
			<div class="row">
				<div id="fsTotal" class="cell lightInactive circle">
					<div class="lightTitle">
						Total
					</div>
					<div id="fsTotalLight" class="lightValue">NO DATA</div>
				</div>
				<div id="fsUsage" class="cell lightInactive circle">
					<div class="lightTitle">
						Usage
					</div>
					<div id="fsUsageLight" class="lightValue">NO DATA</div>
				</div>
				<div id="fsUsagePerc" class="cell lightInactive circle">
					<div class="lightTitle">
						Usage %
					</div>
					<div id="fsPercLight" class="lightValue">NO DATA</div>
				</div>
				<div id="fsFree" class="cell lightInactive circle">
					<div class="lightTitle">
						Free
					</div>
					<div id="fsFreeLight" class="lightValue">NO DATA</div>
				</div>
				<div class="cellSimple" style="padding: 5px;"></div>
			</div>
		</div>
	
		<h3>File system (static)</h3>
		<table id="staticFileSystemTable" class="stripped sortable">
			<thead>
				<tr>
					<th>Dev name</th>
					<th>Dir name</th>
					<th>Options</th>
					<th>System type</th>
					<th>Type</th>
				</tr>
			</thead>
			<tbody>
				<tr id="staticFileSystemRow" class="hidden">
					<td id="devName" class="cellValue" />
					<td id="dirName" class="cellValue" />
					<td id="options" class="cellValue" />
					<td id="sysTypeName" class="cellValue" />
					<td id="typeName" class="cellValue" />
				</tr>
			</tbody>
		</table>


	</div>
</body>

</html>
